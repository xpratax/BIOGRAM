<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BioGram — Rede de Biografias</title>
   <link rel="icon" href="/favicon.ico" sizes="any">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#9aa4b2;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,#051029 0%, #071226 60%);color:#e6eef6;min-height:100vh}
    header{display:flex;align-items:center;gap:16px;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(4px)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700}
    .container{max-width:1100px;margin:28px auto;padding:0 20px}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .search input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .actions{display:flex;gap:8px;margin-top:12px}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:9px;color:white;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .profile-list{display:flex;flex-direction:column;gap:12px;margin-top:14px}
    .profile-mini{display:flex;gap:12px;align-items:center}
    .avatar{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#334155,#0ea5a9);display:flex;align-items:center;justify-content:center;font-weight:700}
    main .feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .bio-card{padding:14px;border-radius:12px;background:var(--card)}
    .bio-card h3{margin:0 0 6px 0}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .tag{font-size:12px;padding:6px 8px;border-radius:999px;background:var(--glass);color:var(--muted)}
    .follow{margin-left:auto}
    .topbar-right{margin-left:auto;display:flex;gap:8px}
    footer{max-width:1100px;margin:24px auto;color:var(--muted);padding:0 20px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}.container{padding:0 14px}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">BG</div>
      <div>
        <div style="font-weight:700">BioGram</div>
        <div style="font-size:12px;color:var(--muted)">Extensão não oficial de biografias — perfil público e link estendido para Instagram</div>
      </div>
    </div>
    <div class="topbar-right" id="auth-area">
      <button id="btn-google">Entrar com Google</button>
      <button class="ghost" id="btn-logout" style="display:none">Sair</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <aside>
        <div class="card">
          <div class="search">
            <input id="search" placeholder="Pesquisar por @handle, nome ou tag" />
          </div>
          <div class="actions">
            <button id="btn-filter">Recentes</button>
            <button class="ghost" id="btn-clear">Limpar</button>
          </div>

          <div class="profile-list" id="profile-list" style="margin-top:14px">
            <!-- mini perfis preenchidos pelo JS -->
          </div>
        </div>

        <div class="card" style="margin-top:16px;text-align:center">
          <div style="font-size:13px;color:var(--muted)">Protótipo — não é afiliado ao Instagram</div>
          <div style="margin-top:8px;font-size:13px">Salvar dados no Supabase (configurar abaixo). Curta, denuncie e usuários podem ser banidos pela equipe.</div>
        </div>
      </aside>

      <main>
        <div class="card" style="margin-bottom:16px">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <h2 style="margin:0">Feed de Biografias</h2>
              <div style="color:var(--muted);font-size:13px">Perfis publicados recentemente</div>
            </div>
            <div style="color:var(--muted);font-size:13px">Total: <span id="total">0</span></div>
          </div>
        </div>

        <div class="card" style="margin-bottom:16px;display:flex;gap:10px;align-items:center">
          <div style="flex:1">
            <div id="me-area" class="muted small">Faça login para criar ou editar sua biografia estendida.<br>Você poderá adicionar também o link do seu Instagram para que visitantes acessem seu perfil.</div>
          </div>
          <div>
            <button id="btn-new" style="display:none">Criar/Editar Biografia</button>
          </div>
        </div>

        <div class="feed" id="feed">
          <!-- cards de biografia -->
        </div>

        <!-- admin panel (aparece somente se usuário for admin) -->
        <div class="card" id="admin-panel" style="margin-top:18px;display:none">
          <h3>Painel de Moderação</h3>
          <div id="reports-list" class="muted small">Carregando denúncias...</div>
        </div>

      </main>
    </div>
  </div>

  <footer>
    <small>BioGram — creditos 
      ° @vm_dantasxz °@richard.stss °@ryan.stss {2025}</small>
  </footer>

  <!-- Modal simples para criar/editar -->
  <div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px">
    <div style="width:100%;max-width:720px;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 20px 60px rgba(2,6,23,0.7)">
      <h3 id="modal-title">Nova Biografia</h3>
      <div style="display:grid;grid-template-columns:1fr 220px;gap:12px">
        <div>
          <label>Instagram handle (sem @) — será exposto como link</label>
          <input id="input-handle" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />

          <label style="margin-top:8px;display:block">Nome público</label>
          <input id="input-name" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />

          <label style="margin-top:8px;display:block">Biografia estendida</label>
          <textarea id="input-bio" rows="5" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)"></textarea>

          <label style="margin-top:8px;display:block">Tags (separe por vírgula)</label>
          <input id="input-tags" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />

        </div>
        <div>
          <label>Avatar URL (opcional)</label>
          <input id="input-avatar" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />
          <div style="margin-top:12px">Preview</div>
          <div id="avatar-preview" style="width:160px;height:160px;border-radius:12px;background:linear-gradient(135deg,#334155,#0ea5a9);display:flex;align-items:center;justify-content:center;font-weight:700;margin-top:8px">BG</div>

          <div style="margin-top:18px;display:flex;gap:8px">
            <button id="save">Salvar</button>
            <button class="ghost" id="cancel">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    /* ====== CONFIGURAÇÃO DO SUPABASE ======
       - Substitua SUPABASE_URL e SUPABASE_ANON_KEY pelas suas credenciais do projeto Supabase.
       - Tabelas (sugestão de schema):
         users (id PK, supabase_id, email, is_admin bool, banned bool)
         profiles (id PK, user_id FK -> users.supabase_id, handle text unique, name text, bio text, tags text[], avatar text, instagram_link text, likes int default 0, updated_at timestamp)
         reports (id PK, profile_id FK, reporter_id, reason text, status text default 'pending', created_at timestamp)
       - Para ações de moderação (ban, mudar status de denúncia) use Edge Functions com SERVICE_ROLE_KEY do Supabase (não deixe essa key no frontend).
    */

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://qwdsfzbcauefyvyyqtav.supabase.co' // <-- substitua
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3ZHNmemJjYXVlZnl2eXlxdGF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTM0NTIsImV4cCI6MjA3OTA2OTQ1Mn0.w2JYwMW_2L9wXZZ7r2D9hE0H6JYcSAFpUwpHv5PXWXE' // <-- substitua

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // DOM refs
    const btnGoogle = document.getElementById('btn-google')
    const btnLogout = document.getElementById('btn-logout')
    const authArea = document.getElementById('auth-area')
    const btnNew = document.getElementById('btn-new')
    const meArea = document.getElementById('me-area')
    const feed = document.getElementById('feed')
    const totalSpan = document.getElementById('total')
    const profileList = document.getElementById('profile-list')
    const searchInput = document.getElementById('search')
    const modal = document.getElementById('modal')

    // Helpers
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]}) }
    function initialsFrom(p){ return (p.name && p.name.split(' ').map(s=>s[0]).slice(0,2).join(''))|| (p.handle? p.handle.slice(0,2).toUpperCase() : 'BG') }

    // Estado local
    let currentUser = null
    let profilesCache = []

    // --- Auth flow (Google via Supabase) ---
    btnGoogle.addEventListener('click', async ()=>{
      await supabase.auth.signInWithOAuth({ provider: 'google' })
      // redireciona para o fluxo de OAuth do Supabase
    })
    btnLogout.addEventListener('click', async ()=>{
      await supabase.auth.signOut(); location.reload();
    })

    // On load: check session
    const { data: { session } } = await supabase.auth.getSession()
    if(session && session.user){
      currentUser = session.user; onLogin();
    }

    // Subscribe to auth changes (for redirect after OAuth)
    supabase.auth.onAuthStateChange((event, session) => {
      if(session && session.user){ currentUser = session.user; onLogin() }
      if(event === 'SIGNED_OUT'){ currentUser = null; location.reload() }
    })

    async function onLogin(){
      btnGoogle.style.display='none'; btnLogout.style.display='inline-block'; btnNew.style.display='inline-block';
      meArea.textContent = `Logado como ${currentUser.email}`
      // Ensure user row exists in users table
      await ensureUserRow(currentUser)
      loadProfiles()
      checkIfAdmin()
    }

    async function ensureUserRow(user){
      // tenta inserir usuário na tabela 'users' caso não exista
      const { data, error } = await supabase.from('users').select('supabase_id,email,is_admin,banned').eq('supabase_id', user.id).limit(1).maybeSingle()
      if(error){ console.error('users select error', error); return }
      if(!data){
        await supabase.from('users').insert([{ supabase_id:user.id, email:user.email, is_admin:false, banned:false }])
      } else {
        if(data.banned){ alert('Você está banido. Contate o suporte.'); await supabase.auth.signOut(); }
      }
    }

    async function checkIfAdmin(){
      const { data, error } = await supabase.from('users').select('is_admin').eq('supabase_id', currentUser.id).limit(1).maybeSingle()
      if(data && data.is_admin){ document.getElementById('admin-panel').style.display='block'; loadReports() }
    }

    // --- Profiles CRUD ---
    btnNew.addEventListener('click', ()=>openModal())
    document.getElementById('cancel').addEventListener('click', ()=>{ modal.style.display='none' })
    document.getElementById('save').addEventListener('click', saveProfile)

    async function saveProfile(){
      if(!currentUser) return alert('Faça login primeiro')
      const handle = document.getElementById('input-handle').value.trim()
      if(!handle) return alert('Handle obrigatório')
      const name = document.getElementById('input-name').value.trim()
      const bio = document.getElementById('input-bio').value.trim()
      const tags = document.getElementById('input-tags').value.split(',').map(s=>s.trim()).filter(Boolean)
      const avatar = document.getElementById('input-avatar').value.trim()
      const instagramLink = handle ? `https://instagram.com/${encodeURIComponent(handle)}` : null

      // upsert profile linked to user
      const payload = {
        user_id: currentUser.id,
        handle, name, bio, tags, avatar, instagram_link: instagramLink, updated_at: new Date().toISOString()
      }
      const { data, error } = await supabase.from('profiles').upsert(payload, { onConflict: ['handle'] }).select().single()
      if(error){ console.error(error); alert('Erro ao salvar: '+error.message); return }
      modal.style.display='none'
      loadProfiles()
    }

    // open modal for create/edit
    function openModal(handle){
      document.getElementById('modal-title').textContent = handle? 'Editar Biografia' : 'Nova Biografia'
      modal.style.display='flex'
      const inpH = document.getElementById('input-handle');
      const inpName = document.getElementById('input-name');
      const inpBio = document.getElementById('input-bio');
      const inpTags = document.getElementById('input-tags');
      const inpAvatar = document.getElementById('input-avatar');
      const preview = document.getElementById('avatar-preview');
      if(handle){
        const p = profilesCache.find(x=>x.handle===handle)
        inpH.value = p.handle; inpH.disabled = true;
        inpName.value = p.name||''; inpBio.value = p.bio||''; inpTags.value = (p.tags||[]).join(', '); inpAvatar.value = p.avatar||'';
        preview.innerHTML = p.avatar? `<img src="${p.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:8px">` : initialsFrom(p);
      } else {
        inpH.disabled=false; inpH.value=''; inpName.value=''; inpBio.value=''; inpTags.value=''; inpAvatar.value=''; preview.innerHTML='BG';
      }
      inpAvatar.oninput = ()=>{ preview.innerHTML = inpAvatar.value ? `<img src="${inpAvatar.value}" style="width:100%;height:100%;object-fit:cover;border-radius:8px">` : initialsFrom({name:inpName.value,handle:inpH.value}); }
    }

    // --- Load & render profiles ---
    async function loadProfiles(){
      const q = searchInput.value.trim().toLowerCase()
      let { data, error } = await supabase.from('profiles').select('*').order('updated_at',{ascending:false})
      if(error){ console.error(error); return }
      profilesCache = data || []
      let out = profilesCache
      if(q){ out = out.filter(p=> (p.handle||'').toLowerCase().includes(q) || (p.name||'').toLowerCase().includes(q) || (p.tags||[]).join(' ').toLowerCase().includes(q) ) }
      renderFeed(out)
      renderSidebar()
    }

    function renderFeed(list){
      feed.innerHTML = '';
      list.forEach(p=>{
        const card = document.createElement('div'); card.className='bio-card card';
        card.innerHTML = `
          <div style="display:flex;gap:12px;align-items:flex-start">
            <div style="width:64px;height:64px;border-radius:12px;overflow:hidden;background:#123">
              ${p.avatar? `<img src="${p.avatar}" style="width:100%;height:100%;object-fit:cover">` : `<div style=\"width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;background:linear-gradient(135deg,#334155,#0ea5a9)\">${escapeHtml(initialsFrom(p))}</div>`}
            </div>
            <div style="flex:1">
              <h3>${escapeHtml(p.name||('@'+p.handle))} <small style='color:var(--muted);font-size:12px'>@${escapeHtml(p.handle)}</small></h3>
              <div style="color:var(--muted);font-size:13px">${escapeHtml(p.bio||'—')}</div>
              <div class="tags">${(p.tags||[]).map(t=>`<span class=\"tag\">${escapeHtml(t)}</span>`).join('')}</div>
              <div style="margin-top:8px" class="small muted">${p.instagram_link? `<a href=\"${p.instagram_link}\" target=\"_blank\">Abrir Instagram</a>` : ''}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <button class="like-btn" data-handle="${escapeHtml(p.handle)}">Curtir (${p.likes||0})</button>
              <button class="ghost report-btn" data-handle="${escapeHtml(p.handle)}">Denunciar</button>
              ${currentUser && currentUser.id===p.user_id? `<button class=\"ghost\" data-edit=\"${escapeHtml(p.handle)}\">Editar</button>` : ''}
            </div>
          </div>
        `;
        feed.appendChild(card);
      })
      totalSpan.textContent = list.length;
    }

    function renderSidebar(){
      profileList.innerHTML = '';
      (profilesCache.slice().reverse()||[]).forEach(p=>{
        const el = document.createElement('div'); el.className='profile-mini';
        el.innerHTML = `
          <div class="avatar">${p.avatar? `<img src=\"${p.avatar}\" style=\"width:100%;height:100%;object-fit:cover;border-radius:8px\">` : initialsFrom(p)}</div>
          <div style="flex:1">
            <div style="font-weight:600">${escapeHtml(p.name||'@'+p.handle)}</div>
            <div style="font-size:12px;color:var(--muted)">@${escapeHtml(p.handle)}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button data-edit="${escapeHtml(p.handle)}" class="ghost">Editar</button>
          </div>
        `;
        profileList.appendChild(el);
      })
    }

    // Delegate clicks (like, report, edit)
    document.body.addEventListener('click', async (e)=>{
      const edit = e.target.closest('[data-edit]');
      if(edit){ const h = edit.getAttribute('data-edit'); openModal(h); }
      const like = e.target.closest('.like-btn');
      if(like){ const h = like.getAttribute('data-handle'); await likeProfile(h); }
      const report = e.target.closest('.report-btn');
      if(report){ const h = report.getAttribute('data-handle'); await reportProfile(h); }
    })

    async function likeProfile(handle){
      if(!currentUser) return alert('Faça login para curtir')
      // Incrementa likes de forma simples (pode-se melhorar com transações/edge function)
      const { data: p } = await supabase.from('profiles').select('id,likes').eq('handle', handle).limit(1).maybeSingle()
      if(!p) return
      const { error } = await supabase.from('profiles').update({ likes: (p.likes||0)+1 }).eq('id', p.id)
      if(error){ console.error(error); alert('Erro ao curtir') } else { loadProfiles() }
    }

    async function reportProfile(handle){
      if(!currentUser) return alert('Faça login para denunciar')
      const reason = prompt('Explique brevemente o motivo da denúncia:')
      if(!reason) return alert('Denúncia cancelada')
      const { data: p } = await supabase.from('profiles').select('id').eq('handle', handle).limit(1).maybeSingle()
      if(!p) return alert('Perfil não encontrado')
      const { error } = await supabase.from('reports').insert([{ profile_id: p.id, reporter_id: currentUser.id, reason, status: 'pending', created_at: new Date().toISOString() }])
      if(error){ console.error(error); alert('Erro ao enviar denúncia') } else { alert('Denúncia enviada — será analisada manualmente pela equipe.') }
    }

    // --- Admin: listar denúncias e banir usuário ---
    async function loadReports(){
      const { data, error } = await supabase.from('reports').select('id,profile_id,reason,status,created_at').order('created_at',{ascending:false})
      const el = document.getElementById('reports-list')
      if(error){ el.textContent = 'Erro ao carregar denúncias'; return }
      if(!data || data.length===0){ el.textContent = 'Nenhuma denúncia pendente' ; return }
      el.innerHTML = '';
      for(const r of data){
        const row = document.createElement('div'); row.style.marginBottom='10px';
        row.innerHTML = `<div><strong>ID:</strong> ${r.id} — <em>${r.status}</em> — ${new Date(r.created_at).toLocaleString()}</div>
                         <div class=\"small muted\">Motivo: ${escapeHtml(r.reason)}</div>
                         <div style=\"margin-top:6px\"><button class=\"ghost\" data-action=\"mark-${r.id}\">Marcar como resolvido</button> <button class=\"ghost\" data-action=\"ban-${r.profile_id}\">Banir usuário</button></div>`
        el.appendChild(row)
      }
    }

    // admin actions -- NOTE: frontend cannot use service_role; these should call Edge Functions on Supabase that run with service role
    document.getElementById('admin-panel').addEventListener('click', async (e)=>{
      const act = e.target.getAttribute('data-action')
      if(!act) return
      if(act.startsWith('mark-')){
        const id = act.split('-')[1]
        // call Edge Function /rpc to mark report resolved (placeholder)
        alert('Esta ação deve ser feita por uma Edge Function no Supabase com SERVICE_ROLE_KEY. Vou chamar uma função exemplo (você precisa implementá-la).')
        // exemplo: await fetch('/.netlify/functions/markReport', {method:'POST', body:JSON.stringify({id})})
      }
      if(act.startsWith('ban-')){
        const profile_id = act.split('-')[1]
        alert('Banimento requer Edge Function com SERVICE_ROLE_KEY. Implemente endpoint admin/ban para alterar users.banned=true e opcionalmente remover profile.')
      }
    })

    // --- Search/filter handlers ---
    document.getElementById('btn-clear').addEventListener('click', ()=>{searchInput.value=''; loadProfiles()})
    document.getElementById('btn-filter').addEventListener('click', ()=>loadProfiles())
    searchInput.addEventListener('input', ()=>loadProfiles())

    // initial load (public)
    await loadProfiles()

    // -- Notes for deployment --
    /*
      1) Crie o projeto no Supabase.
      2) Rode este schema (exemplo):

      -- users
      create table if not exists users (
        id serial primary key,
        supabase_id text unique,
        email text,
        is_admin boolean default false,
        banned boolean default false
      );

      -- profiles
      create table if not exists profiles (
        id serial primary key,
        user_id text,
        handle text unique,
        name text,
        bio text,
        tags text[],
        avatar text,
        instagram_link text,
        likes integer default 0,
        updated_at timestamp
      );

      -- reports
      create table if not exists reports (
        id serial primary key,
        profile_id integer,
        reporter_id text,
        reason text,
        status text default 'pending',
        created_at timestamp
      );

      3) Políticas RLS: para ações sensíveis (banir, editar reports) implemente Edge Functions que rodem com SERVICE_ROLE_KEY e exponha endpoints protegidos para administradores.
      4) No Supabase Auth -> Providers habilite Google e configure OAuth redirect URIs (coloque o domínio do site).
      5) No deploy, não inclua SERVICE_ROLE_KEY no frontend.

      Quer que eu gere também:
        - arquivo SQL pronto (.sql)
        - exemplo de Edge Function para marcar denúncias e banir usuários (TypeScript) pronta pra colar no Supabase
        - README com passos de deploy no Supabase + Vercel
    */

  </script>
</body>
</html>
